/*!
 * GeoFire is an open-source library that allows you to store and query a set
 * of keys based on their geographic location. At its heart, GeoFire simply
 * stores locations with string keys. Its main benefit, however, is the
 * possibility of retrieving only those keys within a given geographic area -
 * all in realtime.
 *
 * GeoFire 0.0.0
 * https://github.com/firebase/geofire-js/
 * License: MIT
 */
var GeoFire=function(){"use strict";function e(e,t){return m(e),b(t),{".priority":t,g:t,l:e}}function t(e){if(null!==e&&e.hasOwnProperty("l")&&Array.isArray(e.l)&&2===e.l.length)return e.l;throw new Error("Unexpected GeoFire location object encountered: "+JSON.stringify(e))}function n(e){var t;return t="function"==typeof e.key?e.key():"string"==typeof e.key||null===e.key?e.key:e.name()}function r(e){var t=null,n=e.val();if(n)for(var r=Object.keys(n),i=null,o=0,a=r.length;a>o;o++)i=r[o],"g"!==i&&"l"!==i&&(t||(t={}),t[i]=n[i]);return t}var i=function(e){if(this.cancel=function(){"undefined"!=typeof t&&(t(),t=void 0)},"function"!=typeof e)throw new Error("callback must be a function");var t=e},o=function(n){if(this.ref=function(){return i},this.set=function(t,n,r){var o;if("string"==typeof t&&0!==t.length){if(r&&"object"!=typeof r)throw new Error("customData must be a Object.");o={},o[t]=n,n&&r&&o[t].push(r)}else{if("object"!=typeof t)throw new Error("keyOrLocations must be a string or a mapping of key - location pairs.");if("undefined"!=typeof n)throw new Error("The location argument should not be used if you pass an object to set().");o=t}var a={};return Object.keys(o).forEach(function(t){v(t);var n=o[t];if(null===n)a[t]=null;else{var r=null;n&&n.length>=3&&(r=n.pop()),m(n);var i=w(n);if(a[t]=e(n,i),r)for(var u=Object.keys(r),f=null,c=0,l=u.length;l>c;c++)f=u[c],a[t][f]=r[f]}}),i.update(a)},this.get=function(e){return v(e),i.child(e).once("value").then(function(e){var n=e.val();if(null===n)return null;var i=t(n);if(i){var o=r(e);o&&i.push(o)}return i})},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new I(i,e)},"[object Object]"!==Object.prototype.toString.call(n))throw new Error("firebaseRef must be an instance of Firebase");var i=n};o.distance=function(e,t){m(e),m(t);var n=6371,r=p(t[0]-e[0]),i=p(t[1]-e[1]),o=Math.sin(r/2)*Math.sin(r/2)+Math.cos(p(e[0]))*Math.cos(p(t[0]))*Math.sin(i/2)*Math.sin(i/2),a=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return n*a};var a=10,u="0123456789bcdefghjkmnpqrstuvwxyz",f=40007860,c=110574,l=5,s=22*l,h=6378137,d=.00669447819799,y=1e-12;Math.log2=Math.log2||function(e){return Math.log(e)/Math.log(2)};var v=function(e){var t;if("string"!=typeof e?t="key must be a string":0===e.length?t="key cannot be the empty string":1+a+e.length>755?t="key is too long to be stored in Firebase":/[\[\].#$\/\u0000-\u001F\u007F]/.test(e)&&(t="key cannot contain any of the following characters: . # $ ] [ /"),"undefined"!=typeof t)throw new Error("Invalid GeoFire key '"+e+"': "+t)},m=function(e){var t;if(Array.isArray(e))if(2!==e.length)t="expected array of length 2, got length "+e.length;else{var n=e[0],r=e[1];"number"!=typeof n||isNaN(n)?t="latitude must be a number":-90>n||n>90?t="latitude must be within the range [-90, 90]":"number"!=typeof r||isNaN(r)?t="longitude must be a number":(-180>r||r>180)&&(t="longitude must be within the range [-180, 180]")}else t="location must be an array";if("undefined"!=typeof t)throw new Error("Invalid GeoFire location '"+e+"': "+t)},b=function(e){var t;if("string"!=typeof e)t="geohash must be a string";else if(0===e.length)t="geohash cannot be the empty string";else for(var n=0,r=e.length;r>n;++n)-1===u.indexOf(e[n])&&(t='geohash cannot contain "'+e[n]+'"');if("undefined"!=typeof t)throw new Error("Invalid GeoFire geohash '"+e+"': "+t)},g=function(e,t){if("object"!=typeof e)throw new Error("query criteria must be an object");if("undefined"==typeof e.center&&"undefined"==typeof e.radius)throw new Error("radius and/or center must be specified");if(t&&("undefined"==typeof e.center||"undefined"==typeof e.radius))throw new Error("query criteria for a new query must contain both a center and a radius");for(var n=Object.keys(e),r=n.length,i=0;r>i;++i){var o=n[i];if("center"!==o&&"radius"!==o)throw new Error("Unexpected attribute '"+o+"'' found in query criteria")}if("undefined"!=typeof e.center&&m(e.center),"undefined"!=typeof e.radius){if("number"!=typeof e.radius||isNaN(e.radius))throw new Error("radius must be a number");if(e.radius<0)throw new Error("radius must be greater than or equal to 0")}},p=function(e){if("number"!=typeof e||isNaN(e))throw new Error("Error: degrees must be a number");return e*Math.PI/180},w=function(e,t){if(m(e),"undefined"!=typeof t){if("number"!=typeof t||isNaN(t))throw new Error("precision must be a number");if(0>=t)throw new Error("precision must be greater than 0");if(t>22)throw new Error("precision cannot be greater than 22");if(Math.round(t)!==t)throw new Error("precision must be an integer")}t=t||a;for(var n={min:-90,max:90},r={min:-180,max:180},i="",o=0,f=0,c=1;i.length<t;){var l=c?e[1]:e[0],s=c?r:n,h=(s.min+s.max)/2;l>h?(o=(o<<1)+1,s.min=h):(o=(o<<1)+0,s.max=h),c=!c,4>f?f++:(f=0,i+=u[o],o=0)}return i},k=function(e,t){var n=p(t),r=Math.cos(n)*h*Math.PI/180,i=1/Math.sqrt(1-d*Math.sin(n)*Math.sin(n)),o=r*i;return y>o?e>0?360:0:Math.min(360,e/o)},M=function(e,t){var n=k(e,t);return Math.abs(n)>1e-6?Math.max(1,Math.log2(360/n)):1},E=function(e){return Math.min(Math.log2(f/2/e),s)},O=function(e){if(180>=e&&e>=-180)return e;var t=e+180;return t>0?t%360-180:180- -t%360},x=function(e,t){var n=t/c,r=Math.min(90,e[0]+n),i=Math.max(-90,e[0]-n),o=2*Math.floor(E(t)),a=2*Math.floor(M(t,r))-1,u=2*Math.floor(M(t,i))-1;return Math.min(o,a,u,s)},j=function(e,t){var n=t/c,r=Math.min(90,e[0]+n),i=Math.max(-90,e[0]-n),o=k(t,r),a=k(t,i),u=Math.max(o,a);return[[e[0],e[1]],[e[0],O(e[1]-u)],[e[0],O(e[1]+u)],[r,e[1]],[r,O(e[1]-u)],[r,O(e[1]+u)],[i,e[1]],[i,O(e[1]-u)],[i,O(e[1]+u)]]},_=function(e,t){b(e);var n=Math.ceil(t/l);if(e.length<n)return[e,e+"~"];e=e.substring(0,n);var r=e.substring(0,e.length-1),i=u.indexOf(e.charAt(e.length-1)),o=t-r.length*l,a=l-o,f=i>>a<<a,c=f+(1<<a);return c>31?[r+u[f],r+"~"]:[r+u[f],r+u[c]]},C=function(e,t){m(e);var n=Math.max(1,x(e,t)),r=Math.ceil(n/l),i=j(e,t),o=i.map(function(e){return _(w(e,r),n)});return o.filter(function(e,t){return!o.some(function(n,r){return t>r&&e[0]===n[0]&&e[1]===n[1]})})},I=function(e,u){function f(e,t,n,r,i){_[e].forEach(function(e){"undefined"==typeof n||null===n?e(t,null,null,null):e(t,n,r,i)})}function c(){_.ready.forEach(function(e){e()})}function l(e){var t=e.split(":");if(2!==t.length)throw new Error("Invalid internal state! Not a valid geohash query: "+e);return t}function s(e){if(2!==e.length)throw new Error("Not a valid geohash query: "+e);return e[0]+":"+e[1]}function h(e,t){var n=j.orderByChild("g").startAt(e[0]).endAt(e[1]);n.off("child_added",t.childAddedCallback),n.off("child_removed",t.childRemovedCallback),n.off("child_changed",t.childChangedCallback),n.off("value",t.valueCallback)}function d(){for(var e=Object.keys(N),t=e.length,n=0;t>n;++n){var r=e[n],i=N[r];if(i.active===!1){var o=l(r);h(o,i),delete N[r]}}for(e=Object.keys(q),t=e.length,n=0;t>n;++n){var a=e[n];if(!v(q[a].geohash)){delete q[a]}}A=!1,null!==Q&&(clearTimeout(Q),Q=null)}function y(e,t,n){m(t);var r,i,u=q.hasOwnProperty(e)?q[e].isInQuery:!1,c=q.hasOwnProperty(e)?q[e].location:null;r=o.distance(t,G),i=D>=r,q[e]={location:t,distanceFromCenter:r,isInQuery:i,geohash:w(t,a),customData:n},i&&!u?f("key_entered",e,t,r,n):!i||null===c||t[0]===c[0]&&t[1]===c[1]?!i&&u&&f("key_exited",e,t,r,n):f("key_moved",e,t,r,n)}function v(e){for(var t=Object.keys(N),n=t.length,r=0;n>r;++r){var i=t[r];if(N.hasOwnProperty(i)){var o=l(i);if(e>=o[0]&&e<=o[1])return!0}}return!1}function b(e,t,n){var r=q[e];if(delete q[e],"undefined"!=typeof r&&r.isInQuery){var i=t?o.distance(t,G):null;f("key_exited",e,t,i,n)}}function p(e){y(n(e),t(e.val()),r(e))}function k(e){y(n(e),t(e.val()),r(e))}function M(e){var i=n(e);q.hasOwnProperty(i)&&j.child(i).once("value",function(n){var o=null===n.val()?null:t(n.val()),a=null!==o?w(o):null,u=r(e);v(a)||b(i,o,u)})}function E(e){var t=x.indexOf(e);t>-1&&x.splice(t,1),F=0===x.length,F&&c()}function O(){var e=C(G,1e3*D).map(s);e=e.filter(function(t,n){return e.indexOf(t)===n});for(var t=Object.keys(N),n=t.length,r=0;n>r;++r){var i=t[r],o=e.indexOf(i);-1===o?N[i].active=!1:(N[i].active=!0,e.splice(o,1))}A===!1&&Object.keys(N).length>25&&(A=!0,Q=setTimeout(d,10)),x=e.slice(),e.forEach(function(e){var t=l(e),n=j.orderByChild("g").startAt(t[0]).endAt(t[1]),r=n.on("child_added",p),i=n.on("child_removed",M),o=n.on("child_changed",k),a=n.on("value",function(){n.off("value",a),E(e)});N[e]={active:!0,childAddedCallback:r,childRemovedCallback:i,childChangedCallback:o,valueCallback:a}}),0===e.length&&E()}if(this.center=function(){return G},this.radius=function(){return D},this.updateCriteria=function(e){g(e),G=e.center||G,D=e.radius||D;for(var t=Object.keys(q),n=t.length,r=0;n>r;++r){var i=t[r];if(I===!0)break;var a=q[i],u=a.isInQuery;a.distanceFromCenter=o.distance(a.location,G),a.isInQuery=a.distanceFromCenter<=D,u&&!a.isInQuery?f("key_exited",i,a.location,a.distanceFromCenter,a.customData):!u&&a.isInQuery&&f("key_entered",i,a.location,a.distanceFromCenter,a.customData)}F=!1,O()},this.on=function(e,t){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(e))throw new Error('event type must be "ready", "key_entered", "key_exited", or "key_moved"');if("function"!=typeof t)throw new Error("callback must be a function");if(_[e].push(t),"key_entered"===e)for(var n=Object.keys(q),r=n.length,o=0;r>o;++o){var a=n[o],u=q[a];"undefined"!=typeof u&&u.isInQuery&&t(a,u.location,u.distanceFromCenter)}return"ready"===e&&F&&t(),new i(function(){_[e].splice(_[e].indexOf(t),1)})},this.cancel=function(){I=!0,_={ready:[],key_entered:[],key_exited:[],key_moved:[]};for(var e=Object.keys(N),t=e.length,n=0;t>n;++n){var r=e[n],i=l(r);h(i,N[r]),delete N[r]}q={},clearInterval(P)},"[object Object]"!==Object.prototype.toString.call(e))throw new Error("firebaseRef must be an instance of Firebase");var x,j=e,_={ready:[],key_entered:[],key_exited:[],key_moved:[]},I=!1,F=!1,q={},N={},A=!1,Q=null,P=setInterval(function(){A===!1&&d()},1e4);g(u,!0);var G=u.center,D=u.radius;O()};return o}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=GeoFire);